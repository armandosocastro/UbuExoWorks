

{% extends "base_template_empleado.html" %}

{% block title %}PAgina inicio logueado{% endblock %}


{% block content2 %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css"/>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.0/bootstrap-table.min.css">
<link rel="stylesheet" href="https://rawgit.com/vitalets/x-editable/master/dist/bootstrap3-editable/css/bootstrap-editable.css">

<link rel='stylesheet' type='text/css' href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.css'/>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.js"></script>


        <div class="col py-3">

            <div id="map" class="modal-content" style="width:100%; height:500px">
                Geo-Localizacion                                  
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div id="calendar" style='width: 350px;'></div>
                </div>
            </div> 
       

            <h2>Listado de fichajes</h2>
            <p class="lead">

                <div class="table-responsive" id="listaFichajes">
                    <table class="table table-striped table-sm" id="tablaFichajes"
                        data-togle="table"
                        data-search="true"
                        data-filter-control="true"
                        data-show-export="true"
                        data-click-to-select="true"
                        data-toolbar="#toolbar">
                      <thead>
                        <tr>
                            <th data-field="fecha" data-filter-control="input" data-sortable="true">Fecha</th>
                            <th data-field="hora" data-filter-control="input" data-sortable="true">Hora</th>
                            <th data-field="longitud" data-filter-control="input" data-sortable="true">Longitud</th>
                            <th data-field="latitud" data-filter-control="input" data-sortable="true">Latitud</th>
                            <th data-field="incidencia" data-sortable="true">Incidencia</th>
                            <th data-field="geolocalizacion" data-sortable="true">Geolocalizacion</th>
                        </tr>
                       </thead>  
                    </table>
                </div>
            </div>  
            
<!-- este es el que tenia funcionando hasta ahora 
                <div class="row">
                    <div class="col-md-12">
                        <div class="calendar calendar-first" id="calendar_first">
                        <div class="calendar_header">
                            <button class="switch-month switch-left"> <i class="fa fa-chevron-left"></i></button>
                             <h2></h2>
                            <button class="switch-month switch-right"> <i class="fa fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar_weekdays"></div>
                        <div class="calendar_content"></div>
                        </div>
                    </div>
                </div>
            </div>   
        -->
   

<!--
                <div class="container-fluid py-3">
                    <h1 class="font-weight-light">Calendario fichajes</h1>
                    <div class="row">
                        <div id="holder" class="col-12">
                            <div data-provide="calendar"></div>
                        </div>
                    </div>
                </div>

                <div class='container' style='margin-top: 100px;'>
                    <input type='text' class="form-control" id='datepicker' style='width: 300px;' > <br>
                    <input type='text' class="form-control" data-provide="datepicker" style='width: 300px;' >

                   </div>
                
                -->      


                <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js" integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
                
                <script type="text/javascript" src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
                <!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>-->
                <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js" integrity="sha384-q2kxQ16AaE6UbzuKqyBE9/u/KzioAlnx2maXQHiDX9d4/zp8Ok3f+M7DPm+Ib6IU" crossorigin="anonymous"></script>
                
                <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
                
                
                
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.0/bootstrap-table.js"></script>
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.9.1/extensions/editable/bootstrap-table-editable.js"></script>
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.9.1/extensions/export/bootstrap-table-export.js"></script>
                <script type="text/javascript" src="https://rawgit.com/hhurz/tableExport.jquery.plugin/master/tableExport.js"></script>
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.9.1/extensions/filter-control/bootstrap-table-filter-control.js"></script>
                
                


                <script type="text/javascript">
                    var parametros = new window.URLSearchParams(window.location.search);    
                    var idUsuario = parametros.get('idUsuario');
                    console.log('idUsuario cargado: ',idUsuario);
                    var fecha_actual = new Date();
                    var strFecha_actual = fecha_actual.getFullYear() + "/" + (fecha_actual.getMonth()+1) + "/" + fecha_actual.getDate();
                    
                    url_home = "{{ url_for('usuarios_blueprint.usuarioFichajesAjax') }}";
                    console.log('url carga:', url_home);
                    var peticionData = {'idUsuario': idUsuario, 'fecha': strFecha_actual};

                    var table = $('#tablaFichajes').DataTable
                    ({

                        language: {
                            "decimal": "",
                            "emptyTable": "No hay información",
                            "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
                            "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
                            "infoFiltered": "(Filtrado de _MAX_ total entradas)",
                            "infoPostFix": "",
                            "thousands": ",",
                            "lengthMenu": "Mostrar _MENU_ Entradas",
                            "loadingRecords": "Cargando...",
                            "processing": "Procesando...",
                            "search": "Buscar:",
                            "zeroRecords": "Sin resultados encontrados",
                            "paginate": {
                                "first": "Primero",
                                "last": "Ultimo",
                                "next": "Siguiente",
                                "previous": "Anterior"
                            }
                        },

                        "ajax": {
                            "method": "POST",
                            //"url": 'http://127.0.0.1:5000/api/ajax/cargatickets',
                            "url": url_home,
                            "data": function () {
                                return peticionData;
                            },
                        },
                        "columns": [
                           
                            {"data":"fecha"},
                            {"data":"hora"},
                            {"data":"longitud"},
                            {"data":"latitud"},
                            {"data":"incidencia"},
                            {"data": "geolocalizacion",
                             "render": function(data, type, row) {
                                return "<button type='button' class='btn btn-primary' id='botonMapa' data-longitud="+row['longitud']+" data-latitud="+row['latitud']+"> Geo-localizacion</button>"
                                }
                            }
                        ]
                    });

                    $('#tablaFichajes tbody').on('click', '.btn-primary', function () {
                        
                        console.log("boton pulsado tiene: ", this.dataset.longitud, this.dataset.latitud);

                        var longitud = this.dataset.longitud
                        var latitud = this.dataset.latitud
                        if (marker == null) {
                            marker = L.marker([longitud,latitud]).addTo(map)
                        }
                        else {
                            marker.setLatLng([longitud, latitud]).update()
                        }
                            map.flyTo([longitud,latitud], 18)
                    });

/*
                        var parametros = new window.URLSearchParams(window.location.search);    
                        var idUsuario = parametros.get('idUsuario');
                        var fecha_actual = new Date();
                        var strFecha_actual = fecha_actual.getFullYear() + "/" + (fecha_actual.getMonth()+1) + "/" + fecha_actual.getDate();
                        //console.log('fecha:', strFecha_actual);
  */             
                        url_eventos = "{{ url_for('usuarios_blueprint.getFichajeCalendario') }}";
                        url_eventos = url_eventos + '?idUsuario=' + idUsuario + '&fecha=' + strFecha_actual;
                        console.log('url peticion fichajes: ', url_eventos);

                        var calendarEl = document.getElementById('calendar');
                        var calendar = new FullCalendar.Calendar(calendarEl, {
                          header: {
                              left: 'title today'
                          },
                          initialView: 'dayGridMonth',
                          locale: 'es',
                          dayMaxEventRows: true,
                          views: {
                              dayGridMonth: {
                                  dayMaxEventRows: 1
                              }
                          },
                          eventSources: [
                            {
                                url: url_eventos,
                                dataType:'json',
                                color: 'blue',
                                textColor: 'white'
                            
                            }
                          ],
                          dateClick: function(info) {
                              var strFecha_pulsada = info.date.getFullYear() + "/" + (info.date.getMonth()+1) + "/" + info.date.getDate();
                              console.log('Dia pulsado: ',strFecha_pulsada);

                              peticionData = {idUsuario: idUsuario, fecha: strFecha_pulsada};
                              console.log('peticion data: ', peticionData);
                              //extraemos el idGasto del atributo data-gasto del boton
                              table.ajax.url(url_home).load();  
                          }
                        });
                        calendar.render();
                </script>

                <script type="text/javascript">
                    var marker = null;
                    // The first parameter are the coordinates of the center of the map
                    // The second parameter is the zoom level
                    var map = L.map('map').setView([40.4167, -3.70325], 5);
                    
                    // {s}, {z}, {x} and {y} are placeholders for map tiles
                    // {x} and {y} are the x/y of where you are on the map
                    // {z} is the zoom level
                    // {s} is the subdomain of cartodb
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '© OpenStreetMap'
                    }).addTo(map);
                    
                  </script>
                
                <script type="text/javascript">
                    console.log('cargado....');
                    const botones = document.querySelectorAll(".btn-primary");

                    const haceClick = function (e) {
                        var triggerButton = $(e.relatedTarget);
                        console.log('aqui', triggerButton.data);
                        console.log("boton pulsado tiene: ", this.dataset.longitud, this.dataset.latitud);

                        var longitud = this.dataset.longitud
                        var latitud = this.dataset.latitud
                        if (marker == null) {
                            marker = L.marker([longitud,latitud]).addTo(map)
                        }
                        else {
                            marker.setLatLng([longitud, latitud]).update()
                        }
                            map.flyTo([longitud,latitud], 18)
                    }
                    console.log('antes de eventos botones');
                    botones.forEach(boton => {
                        console.log('boton');
                        boton.addEventListener("click", haceClick);
                    });
                </script>
<!--
                  <script type="text/javascript">
                    btn = document.querySelector("#botonMapa");
                    btn.addEventListener("click", function() 
                            {
                                console.log('aqui')
                                var longitud = 23.0
                                var latitud = 45.0
                                map.flyTo([longitud,latitud], 10)
                                
                                //document.getElementById('map').innerHTML = "<div id='map' style='width:500px; height:500px'></div>"
                            });
                                //var map = L.map('map').setView([longitud, latitud], 11);
                                
                                //L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                  //  maxZoom: 19,
                                  //  attribution: '© OpenStreetMap'
                                //}).addTo(map);
                               
                    </script>    
                               
                -->   

            </p>
        </div>
    </div>

{% endblock %}


<!--
<script type="text/javascript">
    $(document).ready(function () {
        console.log('Inicializo tabla');
        $('#tablaFichajes').DataTable({
        });
      });
    </script> 
-->