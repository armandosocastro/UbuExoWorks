

{% extends "base_template.html" %}

{% block title %}PAgina inicio fichajes{% endblock %}


{% block content2 %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css"/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.0/bootstrap-table.min.css">
<link rel="stylesheet" href="https://rawgit.com/vitalets/x-editable/master/dist/bootstrap3-editable/css/bootstrap-editable.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.min.css">

<link rel='stylesheet' type='text/css' href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.css'/>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.js"></script>


        <div class="col py-3">

            <div id="map" class="modal-content-mapa" >
                Geo-Localizacion                                  
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div id="calendar" class="mi-calendario"></div>
                </div>
            </div> 
       
                <h5>Rango de fechas</h5>
                <div class="row justify-content-center">
                    <div class="col-lg-3 col-sm-6">
                        <label for="startDate">Desde</label>
                        <input id="startDate" class="form-control" type="date" />
                        <span id="startDateSelected"></span>
                    </div>
                    <div class="col-lg-3 col-sm-6">
                        <label for="endDate">Hasta</label>
                        <input id="endDate" class="form-control" type="date" />
                        <span id="endDateSelected"></span>
                    </div>
                    <div class="col-lg-3 col-sm-3">
                        <br>
                        <button id="btnBuscaRango" >Buscar</button>
                        <span id="fechasSelected" class="span-fechas"></span>
                    </div>

                </div>
            </div>
            <div class="row">
                <h2>Listado de fichajes</h2>
                <p class="lead">
                    
                    <table id="tablaFichajes" 
                        data-sortable="true"
                        data-toggle="table"
                        data-filter-control="true" 
                        data-show-export="true"
                        data-click-to-select="false"
                        class="table">  
                      <thead>
                        <tr>
                            <th data-field="entrada"></th>
                            <th data-field="fecha" data-sortable="true">Fecha</th>
                            <th data-field="hora" data-sortable="true">Hora</th>
                            <th data-field="tipo" data-sortable="true">Tipo</th>
                            <th data-field="longitud" data-sortable="true">Longitud</th>
                            <th data-field="latitud" data-sortable="true">Latitud</th>
                            <th data-field="incidencia" data-sortable="true">Incidencia</th>
                            <th data-field="geolocalizacion">Geolocalizacion</th>
                        </tr>
                       </thead>  
                    </table>
    
            </div>  
        

<!--
                <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js" integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
-->               

                <script type="text/javascript" src="{{ url_for('static', filename='libs/jquery-3.6.0.min.js') }}"></script>
                <script type="text/javascript" src="{{ url_for('static', filename='libs/jquery-3.6.0.js') }}"></script>

                <script type="text/javascript" src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
                <script src="{{ url_for('static', filename='libs/popper.js') }}"></script>

                <script type="text/javascript" src="{{ url_for('static', filename='libs/bootstrap-3.3.5/js/bootstrap.min.js') }}"></script>
  <!--              
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.min.js"></script>
  -->          
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.0/bootstrap-table.js"></script>
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.9.1/extensions/editable/bootstrap-table-editable.js"></script>
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.9.1/extensions/export/bootstrap-table-export.js"></script>
                <script type="text/javascript" src="https://rawgit.com/hhurz/tableExport.jquery.plugin/master/tableExport.js"></script>
                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.9.1/extensions/filter-control/bootstrap-table-filter-control.js"></script> 
                

                <script type="text/javascript" nonce="2726c7f26c">

                  $(function () {  
                    var parametros = new window.URLSearchParams(window.location.search);    
                    var idUsuario = parametros.get('idUsuario');
                    console.log('idUsuario cargado: ',idUsuario);
                    var fecha_actual = new Date();
                    var strFecha_actual = fecha_actual.getFullYear() + "/" + (fecha_actual.getMonth()+1) + "/" + fecha_actual.getDate();
                    
                    url_home = "{{ url_for('usuarios_blueprint.usuarioFichajesAjax') }}";
                    console.log('url carga:', url_home);
                    var peticionData = {'idUsuario': idUsuario, 'fecha': strFecha_actual};

                    //Funcion Ajax para renderizar el boton para mostrar el ticket en funcion del valor del dato almacenado en la BBDD    
                    var entrada = function( data, type, row, meta ) {
                        //console.log('data-gasto:', row['ID']);
                        if (row['tipo'] == 'entrada' || row['tipo'] == 'pausa entrada')
                            //icono = '/libs/bootstrap-icons-1.8.3/caret-right.svg';
                            return "<img class='img-icono-perfil' src='{{ url_for('static', filename='/libs/bootstrap-icons-1.8.3/caret-right.svg') }}'>";
                        else
                            //icono = '/libs/bootstrap-icons-1.8.3/caret-left.svg';
                            return "<img class='img-icono-perfil' src='{{ url_for('static', filename='/libs/bootstrap-icons-1.8.3/caret-left.svg') }}'>";
                    }

                    var table = $('#tablaFichajes').DataTable
                    ({

                        language: {
                            "decimal": "",
                            "emptyTable": "No hay información",
                            "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
                            "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
                            "infoFiltered": "(Filtrado de _MAX_ total entradas)",
                            "infoPostFix": "",
                            "thousands": ",",
                            "lengthMenu": "Mostrar _MENU_ Entradas",
                            "loadingRecords": "Cargando...",
                            "processing": "Procesando...",
                            "search": "Buscar:",
                            "zeroRecords": "Sin resultados encontrados",
                            "paginate": {
                                "first": "Primero",
                                "last": "Ultimo",
                                "next": "Siguiente",
                                "previous": "Anterior"
                            }
                        },
                        "responsive": true,
                         "sPaginationType": "full_numbers",
                         "order": [[1, 'desc']],
                        "ajax": {
                            "method": "POST",
                            //"url": 'http://127.0.0.1:5000/api/ajax/cargatickets',
                            "url": url_home,
                            "data": function () {
                                return peticionData;
                            },
                        },
                        "columns": [
                            {"data":"entrada",
                                "render":entrada}, 
                            {"data":"fecha"},
                            {"data":"hora"},
                            {"data":"tipo"},
                            {"data":"longitud"},
                            {"data":"latitud"},
                            {"data":"incidencia"},
                            {"data": "geolocalizacion",
                             "render": function(data, type, row) {
                                return "<button type='button' class='btn btn-primary' id='botonMapa' data-longitud="+row['longitud']+" data-latitud="+row['latitud']+"> Geo-localizacion</button>"
                                }
                            }
                        ]
                    });

                    $('#tablaFichajes tbody').on('click', '.btn-primary', function () {
                        
                        console.log("boton pulsado tiene: ", this.dataset.longitud, this.dataset.latitud);

                        var longitud = this.dataset.longitud
                        var latitud = this.dataset.latitud
                        if (marker == null) {
                            marker = L.marker([longitud,latitud]).addTo(map)
                        }
                        else {
                            marker.setLatLng([longitud, latitud]).update()
                        }
                            map.flyTo([longitud,latitud], 18)
                    });

                        url_eventos = "{{ url_for('usuarios_blueprint.getFichajeCalendario') }}";
                        url_eventos = url_eventos + '?idUsuario=' + idUsuario + '&fecha=' + strFecha_actual;
                        console.log('url peticion fichajes: ', url_eventos);

                        var calendarEl = document.getElementById('calendar');
                        var calendar = new FullCalendar.Calendar(calendarEl, {
                          header: {
                              left: 'title today'
                          },
                          initialView: 'dayGridMonth',
                          locale: 'es',
                          dayMaxEventRows: true,
                          views: {
                              dayGridMonth: {
                                  dayMaxEventRows: 1
                              }
                          },
                          eventSources: [
                            {
                                url: url_eventos,
                                dataType:'json',
                                color: 'blue',
                                textColor: 'white'
                            
                            }
                          ],
                          dateClick: function(info) {
                              var strFecha_pulsada = info.date.getFullYear() + "/" + (info.date.getMonth()+1) + "/" + info.date.getDate();
                              console.log('Dia pulsado: ',strFecha_pulsada);

                              peticionData = {idUsuario: idUsuario, fecha: strFecha_pulsada};
                              //console.log('peticion data: ', peticionData);
                              //extraemos el idGasto del atributo data-gasto del boton
                              table.ajax.url(url_home).load();  
                          }
                        });
                        calendar.render();

                        let startDate = document.getElementById('startDate')
                        let endDate = document.getElementById('endDate')
    
                        startDate.addEventListener('change',(e)=>{
                        let startDateVal = e.target.value
                        document.getElementById('startDateSelected').innerText = startDateVal
                        })
    
                        endDate.addEventListener('change',(e)=>{
                        let endDateVal = e.target.value
                        document.getElementById('endDateSelected').innerText = endDateVal
                        })  
    
                        document.getElementById('btnBuscaRango').addEventListener('click', 
                            function busquedaPorRango() {
    
                            var url_rangoFechas = "{{ url_for('usuarios_blueprint.usuarioFichajesRangoAjax') }}";
                            var startDateVal = startDate.value;
                            var endDateVal = endDate.value;
                            if (startDateVal === '' || endDateVal === '') {
                                document.getElementById('fechasSelected').innerText = "Rango incorrecto";
                                
                                //console.log('sin fechas correctas')
                            }
                            else {
                            document.getElementById('fechasSelected').innerText = "";                            
                            //console.log('Buscar por rango de fechas:', startDateVal, '/', endDateVal);
                            var Fecha_inicial = new Date(startDateVal);
                            var Fecha_final = new Date(endDateVal);
                            //console.log('date convert:',Fecha_inicial, ':', Fecha_final);
                            var strFecha_inicial = Fecha_inicial.getFullYear() + "/" + (Fecha_inicial.getMonth()+1) + "/" + Fecha_inicial.getDate();
                            var strFecha_final = Fecha_final.getFullYear() + "/" + (Fecha_final.getMonth()+1) + "/" + Fecha_final.getDate();
                            //console.log('Dia pulsado: ',strFecha_pulsada);
    
                            peticionData = {idUsuario: idUsuario, fecha_ini: strFecha_inicial, fecha_fin: strFecha_final};
                            //console.log('peticion data: ', peticionData);
                            //extraemos el idGasto del atributo data-gasto del boton
                            table.ajax.url(url_rangoFechas).load();  
                                }
                        });

                    });
                </script>

                <script type="text/javascript" nonce="2726c7f26c">
                    var marker = null;
                    // The first parameter are the coordinates of the center of the map
                    // The second parameter is the zoom level
                    var map = L.map('map').setView([40.4167, -3.70325], 5);
                    
                    // {s}, {z}, {x} and {y} are placeholders for map tiles
                    // {x} and {y} are the x/y of where you are on the map
                    // {z} is the zoom level
                    // {s} is the subdomain of cartodb
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '© OpenStreetMap'
                    }).addTo(map);
                    
                  </script>
                
                <script type="text/javascript" nonce="2726c7f26c">
                    console.log('cargado....');
                    const botones = document.querySelectorAll(".btn-primary");

                    const haceClick = function (e) {
                        var triggerButton = $(e.relatedTarget);
                        console.log('aqui', triggerButton.data);
                        console.log("boton pulsado tiene: ", this.dataset.longitud, this.dataset.latitud);

                        var longitud = this.dataset.longitud
                        var latitud = this.dataset.latitud
                        if (marker == null) {
                            marker = L.marker([longitud,latitud]).addTo(map)
                        }
                        else {
                            marker.setLatLng([longitud, latitud]).update()
                        }
                            map.flyTo([longitud,latitud], 18)
                    }
                    console.log('antes de eventos botones');
                    botones.forEach(boton => {
                        console.log('boton');
                        boton.addEventListener("click", haceClick);
                    });
                </script>
            </p>
        </div>
    </div>

{% endblock %}
